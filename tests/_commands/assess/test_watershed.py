from math import nan

import numpy as np
import pytest
from pfdf.raster import Raster

from wildcat._commands.assess import _watershed


def rasterize(array):
    return Raster.from_array(
        array,
        crs=32613,
        transform=[
            7.908909437828697,
            -10.101967305876315,
            665591.3682153053,
            4654196.143311787,
        ],
    )


@pytest.fixture
def dem():
    dem = np.array(
        [
            [
                1247.5493,
                1248.2235,
                1248.6603,
                1248.8969,
                1248.4364,
                1247.1224,
                1245.7639,
                1245.1555,
                1245.4117,
                1246.1826,
                1247.004,
                1247.6635,
                1248.3396,
                1248.9231,
                1248.9276,
                1248.3734,
                1247.5696,
                1247.1063,
                1246.7417,
                1246.4147,
            ],
            [
                1246.657,
                1247.2904,
                1247.8466,
                1248.6853,
                1249.7158,
                1250.0197,
                1248.9824,
                1247.4326,
                1246.193,
                1245.6736,
                1246.1852,
                1247.3822,
                1248.543,
                1249.3442,
                1249.3942,
                1248.4777,
                1247.5188,
                1247.6611,
                1248.2557,
                1248.5757,
            ],
            [
                1246.6312,
                1247.0958,
                1247.5038,
                1248.0051,
                1248.7799,
                1249.6451,
                1250.0109,
                1249.7865,
                1249.1892,
                1247.959,
                1246.7407,
                1247.0756,
                1248.7173,
                1249.5464,
                1249.247,
                1248.4137,
                1247.7562,
                1247.6421,
                1248.0586,
                1248.6439,
            ],
            [
                1247.4706,
                1247.8292,
                1248.24,
                1248.7739,
                1249.6079,
                1250.2246,
                1250.4297,
                1250.7675,
                1251.1932,
                1251.3312,
                1250.1812,
                1248.6923,
                1249.1548,
                1249.894,
                1249.7289,
                1248.7976,
                1247.628,
                1246.8534,
                1246.6956,
                1247.0281,
            ],
            [
                1248.7522,
                1249.1957,
                1249.7563,
                1250.4056,
                1251.1661,
                1251.6149,
                1251.719,
                1251.9391,
                1252.1515,
                1252.9294,
                1253.7164,
                1252.8167,
                1251.4434,
                1251.193,
                1251.0076,
                1250.4006,
                1249.1578,
                1247.719,
                1246.5437,
                1246.0308,
            ],
            [
                1250.3496,
                1250.3647,
                1250.1273,
                1250.5367,
                1251.2866,
                1252.2714,
                1252.7316,
                1252.7195,
                1252.8094,
                1253.41,
                1254.7247,
                1255.9609,
                1255.3683,
                1254.0964,
                1253.1804,
                1252.4578,
                1251.415,
                1250.1124,
                1248.7026,
                1247.5786,
            ],
            [
                1252.2938,
                1251.2598,
                1250.6494,
                1250.7583,
                1251.5244,
                1252.8767,
                1254.4214,
                1254.7059,
                1254.3933,
                1254.637,
                1255.216,
                1256.7083,
                1257.6683,
                1257.4022,
                1256.5763,
                1255.3336,
                1253.6953,
                1252.2981,
                1251.1932,
                1250.554,
            ],
            [
                1254.9858,
                1253.7072,
                1252.5823,
                1252.0052,
                1252.4398,
                1253.6494,
                1255.5345,
                1256.69,
                1256.5071,
                1256.6458,
                1256.7323,
                1256.6782,
                1256.6295,
                1257.3423,
                1258.0216,
                1258.2338,
                1256.8971,
                1254.9926,
                1253.9628,
                1253.619,
            ],
            [
                1255.8948,
                1256.5796,
                1256.0524,
                1255.1282,
                1254.8438,
                1255.2739,
                1257.0562,
                1258.7866,
                1259.124,
                1259.2528,
                1258.4984,
                1256.8895,
                1255.3229,
                1255.1589,
                1255.9381,
                1257.7656,
                1259.082,
                1258.0875,
                1257.4562,
                1257.0253,
            ],
            [
                1254.1754,
                1256.0344,
                1257.3201,
                1257.4963,
                1257.1846,
                1256.9337,
                1257.7722,
                1258.592,
                1259.0516,
                1259.7512,
                1259.5303,
                1258.1243,
                1255.8138,
                1254.8214,
                1255.3114,
                1257.066,
                1259.2777,
                1259.5223,
                1258.9965,
                1258.4589,
            ],
            [
                1251.7203,
                1252.726,
                1254.474,
                1256.2186,
                1256.7218,
                1256.9655,
                1256.7115,
                1256.3663,
                1256.5568,
                1257.1953,
                1257.9155,
                1258.2915,
                1257.3131,
                1256.4548,
                1256.8627,
                1258.0348,
                1258.8647,
                1259.38,
                1259.5017,
                1258.8904,
            ],
            [
                1250.5303,
                1251.1874,
                1253.2374,
                1255.6171,
                1256.1073,
                1255.6807,
                1255.0342,
                1254.5637,
                1254.7628,
                1255.3597,
                1255.9777,
                1256.6494,
                1257.2654,
                1257.8212,
                1258.6025,
                1259.1578,
                1258.8451,
                1258.8087,
                1259.2081,
                1258.7875,
            ],
            [
                1251.2676,
                1251.7279,
                1253.2273,
                1255.6389,
                1256.4194,
                1255.3156,
                1253.9216,
                1253.3052,
                1253.7151,
                1254.4756,
                1255.1763,
                1255.6112,
                1256.002,
                1256.9213,
                1258.1753,
                1258.986,
                1259.0836,
                1259.264,
                1259.7443,
                1259.5083,
            ],
            [
                1252.746,
                1253.9653,
                1255.8373,
                1258.1506,
                1257.9855,
                1255.5922,
                1253.9034,
                1253.7017,
                1254.361,
                1255.281,
                1255.8744,
                1255.8673,
                1255.5465,
                1256.5421,
                1258.3773,
                1259.8533,
                1260.4294,
                1260.6794,
                1260.5143,
                1259.987,
            ],
            [
                1254.9125,
                1256.6251,
                1258.9073,
                1260.6074,
                1259.629,
                1256.9468,
                1255.5529,
                1255.6207,
                1256.0797,
                1256.9886,
                1257.9249,
                1257.2646,
                1255.4537,
                1255.8478,
                1258.1105,
                1260.6486,
                1261.692,
                1261.6879,
                1261.1426,
                1259.8809,
            ],
            [
                1255.0916,
                1256.2019,
                1257.502,
                1258.6663,
                1258.9438,
                1257.5897,
                1256.174,
                1255.6077,
                1255.4954,
                1256.0593,
                1257.6599,
                1258.6919,
                1257.7109,
                1257.5662,
                1259.2126,
                1261.63,
                1263.1005,
                1262.8268,
                1262.0648,
                1260.8073,
            ],
            [
                1252.3958,
                1253.2266,
                1254.0056,
                1254.9714,
                1255.9786,
                1256.5278,
                1256.271,
                1255.7769,
                1255.6659,
                1255.888,
                1256.6124,
                1258.0675,
                1258.803,
                1259.3021,
                1260.7517,
                1262.5577,
                1263.9526,
                1263.9474,
                1263.0868,
                1262.0314,
            ],
            [
                1250.6438,
                1251.2153,
                1251.4907,
                1252.2343,
                1253.3282,
                1254.3628,
                1254.9557,
                1255.8506,
                1257.0028,
                1257.7689,
                1258.0114,
                1258.174,
                1259.0378,
                1260.1144,
                1261.1881,
                1262.5122,
                1263.4513,
                1263.8286,
                1263.7717,
                1263.4409,
            ],
            [
                1248.4973,
                1249.3668,
                1249.5107,
                1249.9185,
                1250.911,
                1251.7255,
                1252.4441,
                1253.941,
                1256.0172,
                1257.9127,
                1259.4773,
                1260.2015,
                1260.1099,
                1260.1261,
                1260.6427,
                1261.6561,
                1262.4362,
                1262.7052,
                1262.9492,
                1263.471,
            ],
            [
                1248.062,
                1249.1174,
                1249.2021,
                1249.2173,
                1249.9701,
                1250.5062,
                1250.9886,
                1252.4447,
                1254.3312,
                1256.2378,
                1258.2219,
                1260.4049,
                1261.8783,
                1262.1533,
                1262.2155,
                1262.411,
                1262.4082,
                1262.0204,
                1261.8357,
                1262.1544,
            ],
        ],
        dtype=float,
    )
    return rasterize(dem)


@pytest.fixture
def severity():
    severity = np.ones((20, 20))
    severity[2:4] = 2
    severity[4:6] = 3
    severity[6:8] = 4
    return rasterize(severity)


@pytest.fixture
def retainments():
    retainments = np.zeros((20, 20), bool)
    retainments[5, 5] = True
    return rasterize(retainments)


@pytest.fixture
def rasters(dem, severity):
    return {"dem": dem, "severity": severity}


@pytest.fixture
def isburned():
    isburned = np.zeros((20, 20), bool)
    isburned[2:8, :] = True
    return rasterize(isburned)


@pytest.fixture
def moderate_high():
    modhigh = np.zeros((20, 20), bool)
    modhigh[4:8, :] = True
    return rasterize(modhigh)


@pytest.fixture
def flow():
    flow = np.array(
        [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 5, 5, 5, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 1, 1, 2, 2, 3, 0],
            [0, 5, 5, 5, 5, 5, 2, 2, 3, 3, 4, 4, 5, 5, 1, 1, 8, 7, 7, 0],
            [0, 4, 4, 4, 4, 4, 4, 2, 2, 2, 3, 3, 4, 5, 1, 1, 1, 8, 8, 0],
            [0, 3, 4, 4, 4, 4, 3, 4, 4, 2, 2, 3, 3, 4, 2, 2, 1, 1, 1, 0],
            [0, 4, 4, 4, 5, 5, 3, 4, 4, 4, 5, 2, 3, 3, 2, 2, 2, 2, 3, 0],
            [0, 3, 3, 4, 5, 5, 5, 3, 3, 4, 4, 5, 2, 2, 3, 2, 2, 2, 2, 0],
            [0, 3, 3, 3, 4, 4, 5, 3, 3, 3, 4, 4, 5, 5, 2, 2, 2, 2, 3, 0],
            [0, 2, 3, 3, 3, 4, 4, 4, 3, 3, 1, 1, 4, 5, 5, 5, 2, 2, 3, 0],
            [0, 6, 6, 6, 3, 3, 4, 7, 7, 7, 2, 1, 3, 4, 5, 5, 5, 2, 2, 0],
            [0, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 6, 1, 3, 5, 5, 4, 5, 2, 0],
            [0, 5, 5, 5, 5, 8, 7, 7, 7, 6, 5, 7, 7, 6, 3, 4, 4, 5, 1, 0],
            [0, 4, 5, 5, 5, 7, 7, 7, 7, 6, 5, 5, 5, 5, 5, 5, 3, 3, 2, 0],
            [0, 3, 4, 4, 1, 8, 7, 7, 6, 5, 5, 1, 4, 5, 5, 5, 3, 3, 4, 0],
            [0, 4, 4, 4, 1, 1, 8, 7, 5, 3, 3, 1, 3, 5, 5, 5, 4, 3, 1, 0],
            [0, 6, 7, 7, 6, 1, 1, 7, 6, 5, 5, 2, 3, 3, 4, 5, 4, 2, 2, 0],
            [0, 6, 7, 6, 6, 6, 6, 6, 5, 5, 5, 5, 3, 3, 4, 4, 4, 2, 2, 0],
            [0, 6, 7, 7, 6, 6, 6, 6, 6, 3, 4, 4, 5, 5, 4, 5, 6, 7, 2, 0],
            [0, 5, 6, 7, 6, 6, 6, 6, 6, 6, 6, 3, 4, 4, 5, 5, 5, 7, 7, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        ],
        "int8",
    )
    return rasterize(flow)


@pytest.fixture
def slopes():
    slopes = np.array(
        [
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                8.00868950e-02,
                7.03257515e-02,
                1.06044962e-01,
                2.02140721e-01,
                3.31715308e-01,
                3.18601308e-01,
                2.25411539e-01,
                8.08672006e-02,
                2.04136095e-02,
                6.46865417e-02,
                1.51348300e-01,
                1.46771184e-01,
                1.01303474e-01,
                1.15881969e-01,
                1.21243012e-01,
                3.21520195e-02,
                7.16619799e-02,
                1.49871798e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                5.87438766e-02,
                5.15873906e-02,
                6.33842129e-02,
                9.79654662e-02,
                1.09395613e-01,
                2.00963762e-01,
                2.80092805e-01,
                2.96595694e-01,
                2.26233161e-01,
                8.31743515e-02,
                6.94015955e-02,
                2.07576027e-01,
                1.04831141e-01,
                1.05362188e-01,
                8.31340914e-02,
                7.03681047e-02,
                7.80739015e-02,
                1.34924214e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                9.33772590e-02,
                8.91838563e-02,
                9.89970423e-02,
                1.24929108e-01,
                1.12606115e-01,
                6.11550897e-02,
                1.23019472e-01,
                2.52087422e-01,
                3.57803262e-01,
                3.40577226e-01,
                1.60038134e-01,
                1.62061767e-01,
                9.34642135e-02,
                1.17753277e-01,
                1.47883853e-01,
                9.79401782e-02,
                2.41393465e-02,
                5.18173638e-02,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                1.35270681e-01,
                1.50206441e-01,
                1.68796154e-01,
                1.86458330e-01,
                1.56434189e-01,
                1.27628605e-01,
                1.17649111e-01,
                1.07874897e-01,
                2.14206497e-01,
                3.91599906e-01,
                4.08276910e-01,
                2.26549931e-01,
                1.58866051e-01,
                1.72256880e-01,
                2.16108338e-01,
                1.81921416e-01,
                1.48604559e-01,
                6.48509133e-02,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                1.25685167e-01,
                7.26129003e-02,
                6.08277237e-02,
                9.48171181e-02,
                1.24517800e-01,
                1.00237901e-01,
                7.79832618e-02,
                6.78349153e-02,
                9.80928886e-02,
                1.66230251e-01,
                3.52113329e-01,
                3.88528282e-01,
                2.87409364e-01,
                2.16669536e-01,
                2.57216156e-01,
                2.88082095e-01,
                2.78159787e-01,
                2.13710848e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                8.86065034e-02,
                5.16830023e-02,
                4.91828468e-02,
                9.68654409e-02,
                1.70984383e-01,
                1.95311378e-01,
                1.96634966e-01,
                1.56791242e-01,
                1.42450984e-01,
                1.40767387e-01,
                1.88685939e-01,
                2.78409208e-01,
                3.29065202e-01,
                3.36162244e-01,
                3.05432494e-01,
                2.79266596e-01,
                2.80248694e-01,
                2.81737430e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                2.42269642e-01,
                1.91338968e-01,
                1.23431403e-01,
                1.31063323e-01,
                1.65631616e-01,
                2.38351446e-01,
                1.96407288e-01,
                2.09246371e-01,
                1.98852356e-01,
                1.63316670e-01,
                1.13971699e-01,
                2.52879365e-06,
                8.39635357e-02,
                2.09514251e-01,
                3.53750159e-01,
                3.58465788e-01,
                2.96141534e-01,
                2.74164419e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                3.11566709e-01,
                3.43507348e-01,
                3.09147704e-01,
                2.37973449e-01,
                2.20901911e-01,
                2.65540606e-01,
                2.53482624e-01,
                2.59048552e-01,
                2.58068545e-01,
                2.03428806e-01,
                2.67116474e-02,
                1.55888579e-06,
                2.52879368e-06,
                2.52879365e-06,
                1.37480396e-01,
                3.18745378e-01,
                3.21496812e-01,
                3.45813830e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                3.36259460e-01,
                3.58083861e-01,
                2.35571027e-01,
                2.31717242e-01,
                1.64304630e-01,
                1.94728219e-01,
                2.20323421e-01,
                2.46961797e-01,
                2.53010124e-01,
                2.05835280e-01,
                1.82836839e-01,
                1.97981240e-06,
                1.55888581e-06,
                2.52879365e-06,
                4.90231938e-02,
                2.79646646e-01,
                1.61040697e-01,
                1.53643784e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                1.71142277e-01,
                2.56171702e-01,
                2.32367516e-01,
                8.61050568e-02,
                1.17647381e-01,
                9.25037640e-02,
                5.83322022e-02,
                7.71899152e-02,
                1.40395426e-01,
                1.91824022e-01,
                1.80347497e-01,
                8.02664394e-02,
                1.97981238e-06,
                2.33180063e-02,
                1.48199952e-01,
                1.40198394e-01,
                6.51543685e-02,
                8.12803053e-02,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                8.30835155e-02,
                2.59201350e-01,
                3.00888513e-01,
                6.19807325e-02,
                2.33832868e-06,
                2.96971857e-06,
                2.96971857e-06,
                2.96971857e-06,
                2.33832868e-06,
                2.53726511e-02,
                8.63544668e-02,
                1.25064748e-01,
                1.41796252e-01,
                1.72223879e-01,
                1.78889939e-01,
                6.31598168e-02,
                2.52879365e-06,
                5.31805306e-02,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                9.33460813e-02,
                1.89583660e-01,
                3.04921939e-01,
                9.86861724e-02,
                1.97981238e-06,
                9.89906191e-07,
                9.89906191e-07,
                9.89906191e-07,
                1.55888579e-06,
                2.52879365e-06,
                2.52879368e-06,
                2.84426066e-02,
                1.16236000e-01,
                1.58555362e-01,
                1.02504651e-01,
                2.36072829e-02,
                4.14632108e-02,
                7.45770964e-02,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                2.21481612e-01,
                3.20304264e-01,
                3.83743121e-01,
                2.79243304e-01,
                1.55888579e-06,
                1.97981238e-06,
                1.97981238e-06,
                1.55888579e-06,
                2.52879365e-06,
                1.23139607e-02,
                1.14086526e-02,
                1.55888579e-06,
                9.67301505e-02,
                2.32042106e-01,
                1.86624972e-01,
                1.33221575e-01,
                1.40111323e-01,
                9.74537454e-02,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                3.02353694e-01,
                3.85200680e-01,
                3.71802056e-01,
                3.39136517e-01,
                1.47912934e-01,
                1.55888579e-06,
                1.97981238e-06,
                3.82770852e-02,
                1.19936044e-01,
                2.02980265e-01,
                1.88080292e-01,
                1.97981238e-06,
                8.94054997e-03,
                2.86095070e-01,
                3.20916559e-01,
                1.43316165e-01,
                9.98320396e-02,
                1.59528948e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                2.96663761e-01,
                3.46110801e-01,
                3.65760439e-01,
                3.09625896e-01,
                1.79000659e-01,
                5.02028760e-02,
                2.96971859e-06,
                2.33832870e-06,
                3.57002444e-02,
                2.02379356e-01,
                2.27192795e-01,
                1.91429050e-01,
                1.70105480e-01,
                2.62266946e-01,
                3.05655289e-01,
                1.91111604e-01,
                1.31273773e-01,
                1.70222534e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                2.01314511e-01,
                2.48951509e-01,
                2.71300689e-01,
                2.91846804e-01,
                2.49390549e-01,
                1.48733294e-01,
                6.40094096e-02,
                3.79319050e-06,
                1.40411268e-02,
                9.15929062e-02,
                1.83982382e-01,
                1.08107655e-01,
                1.71837816e-01,
                2.48291535e-01,
                2.60731443e-01,
                1.81033407e-01,
                1.46737920e-01,
                1.77674008e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                2.11852579e-01,
                1.96001426e-01,
                2.29242476e-01,
                2.65766645e-01,
                2.69048099e-01,
                2.51775645e-01,
                2.65517223e-01,
                2.38649826e-01,
                1.86191456e-01,
                1.65506905e-01,
                1.21717803e-01,
                1.09218598e-01,
                1.36124962e-01,
                1.47002930e-01,
                1.67418784e-01,
                1.39925589e-01,
                1.11206062e-01,
                1.35646447e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                1.09939304e-01,
                3.06554891e-02,
                6.94122223e-02,
                1.32014243e-01,
                1.36823406e-01,
                1.51048239e-01,
                2.30122721e-01,
                2.78455975e-01,
                2.79157474e-01,
                2.52500526e-01,
                2.00703481e-01,
                1.50892350e-01,
                8.48267705e-02,
                6.53187401e-02,
                1.28133974e-01,
                9.86355965e-02,
                6.77887761e-02,
                1.10226055e-01,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
        ],
        dtype="float64",
    )
    return rasterize(slopes)


@pytest.fixture
def relief():

    relief = np.array(
        [
            [
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
            ],
            [
                nan,
                1.18960000e00,
                5.56200000e-01,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.27710000e00,
                1.55239000e01,
                8.68470000e00,
                8.42280000e00,
                2.35780000e00,
                1.16080000e00,
                0.00000000e00,
                0.00000000e00,
                9.58900000e-01,
                1.37140000e00,
                0.00000000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                1.00146000e01,
                9.55000000e00,
                9.14200000e00,
                8.64070000e00,
                7.86590000e00,
                0.00000000e00,
                0.00000000e00,
                1.44864000e01,
                2.28540000e00,
                4.50760000e00,
                7.91120000e00,
                1.64170000e00,
                0.00000000e00,
                0.00000000e00,
                6.57500000e-01,
                1.56030000e00,
                0.00000000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                8.90330000e00,
                1.14420000e00,
                1.27010000e00,
                1.60280000e00,
                0.00000000e00,
                7.00070000e00,
                1.14902000e01,
                0.00000000e00,
                0.00000000e00,
                3.44050000e00,
                1.61670000e00,
                7.02080000e00,
                0.00000000e00,
                0.00000000e00,
                1.16960000e00,
                6.32700000e00,
                6.63670000e00,
                6.64800000e-01,
                nan,
            ],
            [
                nan,
                7.70530000e00,
                3.45740000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                4.27620000e00,
                6.21610000e00,
                9.91190000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.28860000e00,
                4.94160000e00,
                0.00000000e00,
                5.55240000e00,
                1.43880000e00,
                8.78990000e00,
                9.30280000e00,
                nan,
            ],
            [
                nan,
                2.50760000e00,
                6.33880000e00,
                1.53030000e00,
                7.49900000e-01,
                0.00000000e00,
                0.00000000e00,
                2.98690000e00,
                4.70670000e00,
                8.52790000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.90340000e00,
                2.77980000e00,
                0.00000000e00,
                7.61460000e00,
                7.15160000e00,
                5.75440000e00,
                nan,
            ],
            [
                nan,
                8.95100000e-01,
                2.45500000e00,
                5.40720000e00,
                4.77620000e00,
                1.35230000e00,
                0.00000000e00,
                1.98640000e00,
                3.69770000e00,
                3.83640000e00,
                7.26940000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.91860000e00,
                3.58290000e00,
                3.59550000e00,
                9.87760000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                1.93290000e00,
                1.24690000e00,
                4.51560000e00,
                4.01010000e00,
                1.88510000e00,
                0.00000000e00,
                2.11380000e00,
                2.00880000e00,
                0.00000000e00,
                5.46340000e00,
                1.99999999e-05,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.79940000e00,
                6.26300000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.40400000e00,
                2.83410000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.11260000e-01,
                4.00118000e00,
                4.00000001e-05,
                1.99999999e-05,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.49340000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.00000002e-05,
                4.00116000e00,
                2.18644000e00,
                2.18642000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                2.19570000e00,
                3.28660000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                5.89270000e-01,
                7.79770000e-01,
                1.41827000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                4.00114000e00,
                4.00112000e00,
                3.81670000e00,
                1.79870000e00,
                0.00000000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                5.08680000e00,
                4.42970000e00,
                2.37970000e00,
                0.00000000e00,
                2.99999999e-05,
                2.99999999e-05,
                5.89300000e-01,
                7.79800000e-01,
                1.41830000e00,
                2.00670000e-01,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.64460000e00,
                1.83428000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                5.30700000e00,
                3.91100000e00,
                2.41160000e00,
                0.00000000e00,
                0.00000000e00,
                3.99999999e-05,
                5.89310000e-01,
                1.41831000e00,
                5.85301000e00,
                5.85299000e00,
                5.85297000e00,
                2.39825000e00,
                2.17330000e00,
                1.25400000e00,
                0.00000000e00,
                2.38480000e-01,
                1.83426000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                2.23740000e00,
                4.10940000e00,
                0.00000000e00,
                0.00000000e00,
                1.99999999e-05,
                5.99999998e-05,
                5.89330000e-01,
                5.85303000e00,
                9.74100000e-02,
                9.73900000e-02,
                0.00000000e00,
                5.85295000e00,
                4.07623000e00,
                3.31120000e00,
                1.47600000e00,
                0.00000000e00,
                1.41540000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                1.16983000e00,
                1.16985000e00,
                5.85305000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                5.85293000e00,
                5.85291000e00,
                4.80080000e00,
                2.53810000e00,
                0.00000000e00,
                0.00000000e00,
                1.26170000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                3.97050000e-01,
                5.85308000e00,
                2.82380000e-01,
                2.82350000e-01,
                0.00000000e00,
                0.00000000e00,
                1.93381000e00,
                5.34030000e00,
                5.78220000e00,
                2.41740000e00,
                0.00000000e00,
                0.00000000e00,
                2.18390000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                2.51490000e00,
                3.48070000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                6.70040000e00,
                5.87918000e00,
                5.87915000e00,
                5.76810000e00,
                0.00000000e00,
                0.00000000e00,
                3.62190000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                5.46070000e00,
                2.31580000e00,
                3.40970000e00,
                3.45180000e00,
                9.93060000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                5.04370000e00,
                3.48210000e00,
                0.00000000e00,
                1.88600000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                0.00000000e00,
                5.85400000e00,
                4.11090000e00,
                5.14550000e00,
                1.16860000e01,
                1.93790000e00,
                2.95240000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                2.61830000e00,
                1.53000000e00,
                1.01340000e00,
                0.00000000e00,
                6.84800000e-01,
                0.00000000e00,
                nan,
            ],
            [
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
                nan,
            ],
        ],
        dtype="float64",
    )
    return rasterize(relief)


@pytest.fixture
def area():
    area = np.array(
        [
            [
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                239.6866337,
                3515.40396091,
                2077.28415872,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                319.58217826,
                239.6866337,
                79.89554457,
            ],
            [
                319.58217826,
                239.6866337,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                3275.71732721,
                1997.38861415,
                1438.11980219,
                239.6866337,
                159.79108913,
                79.89554457,
                79.89554457,
                159.79108913,
                239.6866337,
                79.89554457,
                79.89554457,
                79.89554457,
            ],
            [
                4394.25495113,
                2157.17970328,
                1917.49306959,
                1677.80643589,
                1438.11980219,
                1278.32871306,
                79.89554457,
                79.89554457,
                3115.92623808,
                159.79108913,
                319.58217826,
                1118.53762393,
                159.79108913,
                79.89554457,
                79.89554457,
                159.79108913,
                239.6866337,
                79.89554457,
                79.89554457,
                79.89554457,
            ],
            [
                79.89554457,
                2157.17970328,
                159.79108913,
                159.79108913,
                159.79108913,
                79.89554457,
                1198.43316849,
                3036.03069351,
                79.89554457,
                79.89554457,
                159.79108913,
                239.6866337,
                639.16435653,
                79.89554457,
                79.89554457,
                239.6866337,
                639.16435653,
                1038.64207936,
                159.79108913,
                79.89554457,
            ],
            [
                319.58217826,
                1757.70198045,
                319.58217826,
                79.89554457,
                79.89554457,
                79.89554457,
                399.47772283,
                719.05990109,
                2956.13514895,
                79.89554457,
                79.89554457,
                79.89554457,
                239.6866337,
                239.6866337,
                79.89554457,
                319.58217826,
                159.79108913,
                479.3732674,
                2077.28415872,
                2316.97079242,
            ],
            [
                79.89554457,
                239.6866337,
                1677.80643589,
                239.6866337,
                159.79108913,
                79.89554457,
                79.89554457,
                239.6866337,
                639.16435653,
                2876.23960438,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                239.6866337,
                79.89554457,
                239.6866337,
                239.6866337,
                239.6866337,
                639.16435653,
            ],
            [
                79.89554457,
                159.79108913,
                319.58217826,
                1278.32871306,
                559.26881196,
                159.79108913,
                79.89554457,
                159.79108913,
                239.6866337,
                319.58217826,
                2716.44851525,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                159.79108913,
                159.79108913,
                559.26881196,
                79.89554457,
            ],
            [
                79.89554457,
                79.89554457,
                239.6866337,
                159.79108913,
                479.3732674,
                319.58217826,
                159.79108913,
                79.89554457,
                159.79108913,
                159.79108913,
                79.89554457,
                2556.65742611,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                319.58217826,
                79.89554457,
            ],
            [
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                239.6866337,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                239.6866337,
                2316.97079242,
                239.6866337,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                159.79108913,
            ],
            [
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                1597.91089132,
                399.47772283,
                319.58217826,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
            ],
            [
                159.79108913,
                159.79108913,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                159.79108913,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                1118.53762393,
                958.74653479,
                719.05990109,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
            ],
            [
                1597.91089132,
                639.16435653,
                399.47772283,
                239.6866337,
                79.89554457,
                159.79108913,
                159.79108913,
                239.6866337,
                239.6866337,
                479.3732674,
                239.6866337,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                639.16435653,
                399.47772283,
                79.89554457,
                239.6866337,
            ],
            [
                79.89554457,
                719.05990109,
                319.58217826,
                159.79108913,
                79.89554457,
                79.89554457,
                399.47772283,
                319.58217826,
                798.95544566,
                2716.44851525,
                2636.55297068,
                2556.65742611,
                479.3732674,
                239.6866337,
                159.79108913,
                79.89554457,
                159.79108913,
                319.58217826,
                79.89554457,
                79.89554457,
            ],
            [
                159.79108913,
                159.79108913,
                159.79108913,
                79.89554457,
                79.89554457,
                239.6866337,
                479.3732674,
                399.47772283,
                3914.88168374,
                319.58217826,
                159.79108913,
                79.89554457,
                1917.49306959,
                319.58217826,
                239.6866337,
                159.79108913,
                79.89554457,
                159.79108913,
                79.89554457,
                79.89554457,
            ],
            [
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                958.74653479,
                4474.1504957,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                1438.11980219,
                1038.64207936,
                239.6866337,
                159.79108913,
                79.89554457,
                79.89554457,
                159.79108913,
                399.47772283,
            ],
            [
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
                5672.58366419,
                239.6866337,
                159.79108913,
                79.89554457,
                79.89554457,
                159.79108913,
                399.47772283,
                319.58217826,
                159.79108913,
                79.89554457,
                79.89554457,
                159.79108913,
                159.79108913,
            ],
            [
                159.79108913,
                79.89554457,
                159.79108913,
                239.6866337,
                79.89554457,
                79.89554457,
                79.89554457,
                7270.49455551,
                1278.32871306,
                1198.43316849,
                958.74653479,
                79.89554457,
                79.89554457,
                239.6866337,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                159.79108913,
            ],
            [
                159.79108913,
                79.89554457,
                479.3732674,
                159.79108913,
                159.79108913,
                159.79108913,
                7350.39010008,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                798.95544566,
                559.26881196,
                79.89554457,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
            ],
            [
                239.6866337,
                79.89554457,
                559.26881196,
                399.47772283,
                239.6866337,
                7430.28564465,
                159.79108913,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                399.47772283,
                319.58217826,
                239.6866337,
                79.89554457,
                159.79108913,
                79.89554457,
                79.89554457,
            ],
            [
                79.89554457,
                639.16435653,
                79.89554457,
                719.05990109,
                7510.18118921,
                239.6866337,
                239.6866337,
                159.79108913,
                159.79108913,
                159.79108913,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                79.89554457,
                239.6866337,
                159.79108913,
                79.89554457,
            ],
        ]
    )
    return rasterize(area / 1e6)


@pytest.fixture
def burned_area():

    area = np.array(
        [
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                9.58746535e-04,
                1.59791089e-03,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                7.98955446e-05,
                8.78850990e-04,
                1.59791089e-03,
                1.11853762e-03,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                3.43550842e-03,
                1.99738861e-03,
                1.75770198e-03,
                1.51801535e-03,
                1.27832871e-03,
                1.11853762e-03,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-04,
                1.59791089e-04,
                3.19582178e-04,
                1.11853762e-03,
                1.59791089e-04,
                7.98955446e-05,
                7.98955446e-05,
                1.59791089e-04,
                2.39686634e-04,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
            ],
            [
                7.98955446e-05,
                1.35822426e-03,
                1.59791089e-04,
                1.59791089e-04,
                1.59791089e-04,
                7.98955446e-05,
                1.03864208e-03,
                7.19059901e-04,
                7.98955446e-05,
                7.98955446e-05,
                1.59791089e-04,
                2.39686634e-04,
                6.39164357e-04,
                7.98955446e-05,
                7.98955446e-05,
                2.39686634e-04,
                6.39164357e-04,
                1.03864208e-03,
                1.59791089e-04,
                7.98955446e-05,
            ],
            [
                3.19582178e-04,
                9.58746535e-04,
                3.19582178e-04,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                3.99477723e-04,
                5.59268812e-04,
                6.39164357e-04,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                2.39686634e-04,
                2.39686634e-04,
                7.98955446e-05,
                3.19582178e-04,
                1.59791089e-04,
                4.79373267e-04,
                2.07728416e-03,
                2.31697079e-03,
            ],
            [
                7.98955446e-05,
                2.39686634e-04,
                8.78850990e-04,
                2.39686634e-04,
                1.59791089e-04,
                7.98955446e-05,
                7.98955446e-05,
                2.39686634e-04,
                4.79373267e-04,
                5.59268812e-04,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                1.59791089e-04,
                2.39686634e-04,
                7.98955446e-05,
                2.39686634e-04,
                2.39686634e-04,
                2.39686634e-04,
                3.19582178e-04,
            ],
            [
                7.98955446e-05,
                1.59791089e-04,
                1.59791089e-04,
                6.39164357e-04,
                3.99477723e-04,
                1.59791089e-04,
                7.98955446e-05,
                1.59791089e-04,
                1.59791089e-04,
                2.39686634e-04,
                3.99477723e-04,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                1.59791089e-04,
                1.59791089e-04,
                1.59791089e-04,
                2.39686634e-04,
                7.98955446e-05,
            ],
            [
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                1.59791089e-04,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                2.39686634e-04,
                1.59791089e-04,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
                7.98955446e-05,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
            [
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
                0.00000000e00,
            ],
        ]
    )
    return rasterize(area)


@pytest.fixture
def nretainments():

    count = np.array(
        [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        ]
    )
    return rasterize(count)


class TestMask:
    def test_burned(_, rasters, isburned, logcheck):
        description = "burned areas"
        output = _watershed._mask(rasters, description, logcheck.log)
        assert isinstance(output, Raster)
        assert np.array_equal(output.values, isburned.values)
        logcheck.check([("DEBUG", "    Locating burned areas")])

    def test_moderate_high(_, rasters, moderate_high, logcheck):
        description = "moderate-high burn severity"
        output = _watershed._mask(rasters, description, logcheck.log)
        assert isinstance(output, Raster)
        assert np.array_equal(output.values, moderate_high.values)
        logcheck.check([("DEBUG", "    Locating moderate-high burn severity")])


class TestSeverityMasks:
    def test(_, rasters, isburned, moderate_high, logcheck):
        _watershed.severity_masks(rasters, logcheck.log)
        assert "burned" in rasters
        assert "moderate-high" in rasters
        assert np.array_equal(rasters["burned"].values, isburned.values)
        assert np.array_equal(rasters["moderate-high"].values, moderate_high.values)


class TestCharacterize:
    def test(_, rasters, flow, slopes, relief, logcheck):
        config = {"dem_per_m": 1}
        _watershed.characterize(config, rasters, logcheck.log)

        assert "flow" in rasters
        assert "slopes" in rasters
        assert "relief" in rasters

        assert np.array_equal(rasters["flow"].values, flow.values)
        assert np.allclose(rasters["slopes"].values, slopes.values, equal_nan=True)
        assert np.allclose(rasters["relief"].values, relief.values, equal_nan=True)

        logcheck.check(
            [
                ("INFO", "Characterizing watershed"),
                ("DEBUG", "    Conditioning the DEM"),
                ("DEBUG", "    Determining flow directions"),
                ("DEBUG", "    Computing flow slopes"),
                ("DEBUG", "    Computing vertical relief"),
            ]
        )


class TestAccumulation:
    def test(_, rasters, flow, isburned, area, burned_area, logcheck):
        rasters["flow"] = flow
        rasters["burned"] = isburned

        _watershed.accumulation(rasters, logcheck.log)

        assert "area" in rasters
        assert "burned-area" in rasters
        assert "nretainments" not in rasters

        assert np.allclose(rasters["area"].values, area.values, equal_nan=True)
        assert np.allclose(rasters["burned-area"].values, burned_area.values)

        logcheck.check(
            [
                ("INFO", "Computing flow accumulations"),
                ("DEBUG", "    Total catchment area"),
                ("DEBUG", "    Burned catchment area"),
            ]
        )

    def test_retainments(
        _,
        rasters,
        flow,
        isburned,
        retainments,
        area,
        burned_area,
        nretainments,
        logcheck,
    ):
        rasters["flow"] = flow
        rasters["burned"] = isburned
        rasters["retainments"] = retainments

        _watershed.accumulation(rasters, logcheck.log)

        assert "area" in rasters
        assert "burned-area" in rasters
        assert "nretainments" in rasters

        assert np.allclose(rasters["area"].values, area.values, equal_nan=True)
        assert np.allclose(rasters["burned-area"].values, burned_area.values)
        assert np.array_equal(rasters["nretainments"].values, nretainments.values)

        logcheck.check(
            [
                ("INFO", "Computing flow accumulations"),
                ("DEBUG", "    Total catchment area"),
                ("DEBUG", "    Burned catchment area"),
                ("DEBUG", "    Areas below retainment features"),
            ]
        )

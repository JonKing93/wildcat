from pathlib import Path

import fiona
import numpy as np
import pytest

from wildcat import version
from wildcat._commands.assess import _save


@pytest.fixture
def assessment(tmp_path):
    return Path(tmp_path)


@pytest.fixture
def paths(assessment):
    return {
        "perimeter_p": assessment / "perimeter.tif",
        "dem_p": assessment / "dem.tif",
    }


def prop_keys(record) -> list[str]:
    return list(sorted(record["properties"].keys()))


def check_records(output, expected):
    assert len(output) == len(expected)
    for output, expected in zip(output, expected):
        assert output["geometry"] == expected["geometry"]
        assert prop_keys(output) == prop_keys(expected)
        for field in output["properties"]:
            assert np.allclose(
                output["properties"][field], expected["properties"][field]
            )


class TestFinalize:
    def test(_, config, all_props):
        _save._finalize(config, all_props)
        output = all_props
        fields = list(output.keys())
        assert "hazard" not in fields
        assert fields == [
            "Segment_ID",
            "Area_km2",
            "ExtRatio",
            "BurnRatio",
            "Slope",
            "ConfAngle",
            "DevAreaKm2",
            "InPerim",
            "Terrain_M1",
            "Fire_M1",
            "Soil_M1",
            "Bmh_km2",
            "Relief_m",
            "H_0",
            "P_0",
            "V_0",
            "Vmin_0_0",
            "Vmax_0_0",
            "Vmin_0_1",
            "Vmax_0_1",
            "H_1",
            "P_1",
            "V_1",
            "Vmin_1_0",
            "Vmax_1_0",
            "Vmin_1_1",
            "Vmax_1_1",
            "H_2",
            "P_2",
            "V_2",
            "Vmin_2_0",
            "Vmax_2_0",
            "Vmin_2_1",
            "Vmax_2_1",
            "I_0_0",
            "R_0_0",
            "I_0_1",
            "R_0_1",
            "I_1_0",
            "R_1_0",
            "I_1_1",
            "R_1_1",
            "I_2_0",
            "R_2_0",
            "I_2_1",
            "R_2_1",
        ]
        expected = {
            "Segment_ID": np.array([1, 2, 3, 4, 5, 6, 7, 8]),
            "H_0": np.array([1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]),
            "P_0": np.array(
                [
                    0.11002361,
                    0.19744073,
                    0.33944157,
                    0.30632435,
                    0.28276936,
                    0.17670979,
                    0.10587792,
                    0.11943936,
                ]
            ),
            "V_0": np.array(
                [
                    54.78100096,
                    49.886864,
                    136.77950639,
                    98.23690049,
                    169.80542023,
                    45.95804746,
                    49.7021013,
                    63.04258504,
                ]
            ),
            "Vmin_0_0": np.array(
                [
                    9.90159311,
                    9.01698436,
                    24.72271397,
                    17.75618918,
                    30.69210399,
                    8.30685599,
                    8.98358874,
                    11.39486345,
                ]
            ),
            "Vmax_0_0": np.array(
                [
                    303.07830611,
                    276.00127733,
                    756.73865719,
                    543.49998857,
                    939.45598339,
                    254.26492639,
                    274.97906952,
                    348.78588473,
                ]
            ),
            "Vmin_0_1": np.array(
                [
                    7.13477626,
                    6.49735504,
                    17.81440933,
                    12.7945509,
                    22.11576385,
                    5.9856589,
                    6.47329122,
                    8.21077985,
                ]
            ),
            "Vmax_0_1": np.array(
                [
                    420.60997538,
                    383.03266227,
                    1050.19667048,
                    754.26552216,
                    1303.77051105,
                    352.86710488,
                    381.61404935,
                    484.04263661,
                ]
            ),
            "H_1": np.array([1.0, 1.0, 2.0, 2.0, 2.0, 1.0, 1.0, 1.0]),
            "P_1": np.array(
                [
                    0.15373203,
                    0.30038628,
                    0.5188087,
                    0.47148099,
                    0.43635774,
                    0.26580728,
                    0.14685993,
                    0.16942787,
                ]
            ),
            "V_1": np.array(
                [
                    65.85638976,
                    59.97277709,
                    164.43300279,
                    118.09801744,
                    204.13595482,
                    55.24964921,
                    59.75065986,
                    75.78826562,
                ]
            ),
            "Vmin_1_0": np.array(
                [
                    11.90345491,
                    10.83999974,
                    29.72104668,
                    21.34605967,
                    36.89730249,
                    9.98630065,
                    10.79985235,
                    13.69862827,
                ]
            ),
            "Vmax_1_0": np.array(
                [
                    364.35338354,
                    331.80203673,
                    909.73284673,
                    653.38249488,
                    1129.39118152,
                    305.6711232,
                    330.57316332,
                    419.30192518,
                ]
            ),
            "Vmin_1_1": np.array(
                [
                    8.57725485,
                    7.81096254,
                    21.41605053,
                    15.38129856,
                    26.58703453,
                    7.19581385,
                    7.78203359,
                    9.87080025,
                ]
            ),
            "Vmax_1_1": np.array(
                [
                    505.6471037,
                    460.47256993,
                    1262.52094774,
                    906.75970383,
                    1567.36126434,
                    424.20826899,
                    458.7671479,
                    581.90430945,
                ]
            ),
            "H_2": np.array([1.0, 2.0, 2.0, 2.0, 2.0, 1.0, 1.0, 1.0]),
            "P_2": np.array(
                [
                    0.21069354,
                    0.42835867,
                    0.69345555,
                    0.64312649,
                    0.60320832,
                    0.37914002,
                    0.20015381,
                    0.23476014,
                ]
            ),
            "V_2": np.array(
                [
                    77.78475303,
                    70.83545988,
                    194.21624171,
                    139.48874442,
                    241.11046609,
                    65.25684651,
                    70.57311124,
                    89.51555871,
                ]
            ),
            "Vmin_2_0": np.array(
                [
                    14.05949071,
                    12.80341522,
                    35.10432753,
                    25.21240514,
                    43.58039625,
                    11.79508826,
                    12.75599605,
                    16.17981825,
                ]
            ),
            "Vmax_2_0": np.array(
                [
                    430.34757989,
                    391.90030878,
                    1074.50993082,
                    771.72763618,
                    1333.95429734,
                    361.03638405,
                    390.44885333,
                    495.24878016,
                ]
            ),
            "Vmin_2_1": np.array(
                [
                    10.13082637,
                    9.22573791,
                    25.29507322,
                    18.16726538,
                    31.40266149,
                    8.49916926,
                    9.19156915,
                    11.65866764,
                ]
            ),
            "Vmax_2_1": np.array(
                [
                    597.23339261,
                    543.87653588,
                    1491.19744449,
                    1070.99827178,
                    1851.25254053,
                    501.04379478,
                    541.86221606,
                    687.30282911,
                ]
            ),
            "I_0_0": np.array(
                [
                    37.72653459,
                    26.07252052,
                    19.59371217,
                    20.64963877,
                    21.51721456,
                    27.77352716,
                    38.81199881,
                    35.5827845,
                ]
            ),
            "R_0_0": np.array(
                [
                    9.43163365,
                    6.51813013,
                    4.89842804,
                    5.16240969,
                    5.37930364,
                    6.94338179,
                    9.7029997,
                    8.89569612,
                ]
            ),
            "I_0_1": np.array(
                [
                    49.14439534,
                    33.96331706,
                    25.52371024,
                    26.89921093,
                    28.0293568,
                    36.17912998,
                    50.55837315,
                    46.35184354,
                ]
            ),
            "R_0_1": np.array(
                [
                    12.28609883,
                    8.49082927,
                    6.38092756,
                    6.72480273,
                    7.0073392,
                    9.0447825,
                    12.63959329,
                    11.58796089,
                ]
            ),
            "I_1_0": np.array(
                [
                    29.12758447,
                    20.60272437,
                    14.82805455,
                    15.52757431,
                    16.2402096,
                    20.8912037,
                    29.28346102,
                    26.84638624,
                ]
            ),
            "R_1_0": np.array(
                [
                    14.56379223,
                    10.30136219,
                    7.41402728,
                    7.76378715,
                    8.1201048,
                    10.44560185,
                    14.64173051,
                    13.42319312,
                ]
            ),
            "I_1_1": np.array(
                [
                    37.99182885,
                    26.87264298,
                    19.34059831,
                    20.25299922,
                    21.18250706,
                    27.24891371,
                    38.19514249,
                    35.01640559,
                ]
            ),
            "R_1_1": np.array(
                [
                    18.99591443,
                    13.43632149,
                    9.67029915,
                    10.12649961,
                    10.59125353,
                    13.62445685,
                    19.09757125,
                    17.50820279,
                ]
            ),
            "I_2_0": np.array(
                [
                    24.88372093,
                    17.28002349,
                    13.07924121,
                    13.96281737,
                    14.45712746,
                    18.88235294,
                    27.88610039,
                    25.00486855,
                ]
            ),
            "R_2_0": np.array(
                [
                    24.88372093,
                    17.28002349,
                    13.07924121,
                    13.96281737,
                    14.45712746,
                    18.88235294,
                    27.88610039,
                    25.00486855,
                ]
            ),
            "I_2_1": np.array(
                [
                    33.40009526,
                    23.19405656,
                    17.55556991,
                    18.7415472,
                    19.40503335,
                    25.34477817,
                    37.43002953,
                    33.56270527,
                ]
            ),
            "R_2_1": np.array(
                [
                    33.40009526,
                    23.19405656,
                    17.55556991,
                    18.7415472,
                    19.40503335,
                    25.34477817,
                    37.43002953,
                    33.56270527,
                ]
            ),
            "Terrain_M1": np.array(
                [0.25, 0.36363636, 0.3902439, 0.2962963, 0.32, 0.2, 0.0, 0.0625]
            ),
            "Fire_M1": np.array(
                [
                    0.2125,
                    0.39972727,
                    0.33404878,
                    0.31096296,
                    0.30389333,
                    0.24,
                    0.23333333,
                    0.23125,
                ]
            ),
            "Soil_M1": np.array(
                [0.2, 0.2, 0.51034483, 0.53333333, 0.48571429, 0.4, 0.31111111, 0.325]
            ),
            "Bmh_km2": np.array(
                [0.0004, 0.0004, 0.0019, 0.0009, 0.0028, 0.0001, 0.0001, 0.0002]
            ),
            "Relief_m": np.array(
                [64.0, 53.0, 115.0, 105.0, 128.0, 110.0, 123.0, 121.0]
            ),
            "Area_km2": np.array(
                [0.0016, 0.0011, 0.0041, 0.0027, 0.0075, 0.0005, 0.0009, 0.0016]
            ),
            "ExtRatio": np.array(
                [0.0016, 0.0011, 0.0041, 0.0027, 0.0075, 0.0005, 0.0009, 0.0016]
            ),
            "BurnRatio": np.array(
                [0.0016, 0.0011, 0.0041, 0.0027, 0.0075, 0.0005, 0.0009, 0.0016]
            ),
            "Slope": np.array(
                [0.0016, 0.0011, 0.0041, 0.0027, 0.0075, 0.0005, 0.0009, 0.0016]
            ),
            "ConfAngle": np.array(
                [0.0016, 0.0011, 0.0041, 0.0027, 0.0075, 0.0005, 0.0009, 0.0016]
            ),
            "DevAreaKm2": np.array(
                [0.0016, 0.0011, 0.0041, 0.0027, 0.0075, 0.0005, 0.0009, 0.0016]
            ),
            "InPerim": np.array([False, False, True, True, True, False, False, False]),
        }
        for key, values in expected.items():
            assert np.allclose(output[key], values)

    def test_no_results(_, config, unmodeled_vars):
        _save._finalize(config, unmodeled_vars)
        output = unmodeled_vars
        assert list(output.keys()) == [
            "Segment_ID",
            "Area_km2",
            "ExtRatio",
            "BurnRatio",
            "Slope",
            "ConfAngle",
            "DevAreaKm2",
            "InPerim",
            "Terrain_M1",
            "Fire_M1",
            "Soil_M1",
            "Bmh_km2",
            "Relief_m",
        ]


class TestResults:
    def test(_, assessment, config, segments, all_props, logcheck):
        for name in ["segments", "outlets", "basins"]:
            path = assessment / f"{name}.geojson"
            assert not path.exists()
        _save.results(assessment, config, segments, all_props, logcheck.log)

        for name in ["segments", "outlets", "basins"]:
            path = assessment / f"{name}.geojson"
            assert path.exists()

        with fiona.open(assessment / "segments.geojson") as file:
            records = list(file)
        records = [record.__geo_interface__ for record in records]
        expected = [
            {
                "geometry": {
                    "coordinates": [
                        (15.0, -15.0),
                        (15.0, -25.0),
                        (15.0, -35.0),
                        (15.0, -45.0),
                        (25.0, -45.0),
                        (35.0, -45.0),
                        (35.0, -55.0),
                        (45.0, -55.0),
                        (55.0, -55.0),
                    ],
                    "type": "LineString",
                },
                "id": "0",
                "properties": {
                    "Segment_ID": 1,
                    "Area_km2": 0.0016,
                    "ExtRatio": 0.0016,
                    "BurnRatio": 0.0016,
                    "Slope": 0.0016,
                    "ConfAngle": 0.0016,
                    "DevAreaKm2": 0.0016,
                    "InPerim": 0,
                    "Terrain_M1": 0.25,
                    "Fire_M1": 0.2125,
                    "Soil_M1": 0.2,
                    "Bmh_km2": 0.0004,
                    "Relief_m": 64.0,
                    "H_0": 1.0,
                    "P_0": 0.11002360560928533,
                    "V_0": 54.78100096337253,
                    "Vmin_0_0": 9.901593106691934,
                    "Vmax_0_0": 303.0783061082205,
                    "Vmin_0_1": 7.134776258764663,
                    "Vmax_0_1": 420.60997538115055,
                    "H_1": 1.0,
                    "P_1": 0.15373203482062126,
                    "V_1": 65.85638975869297,
                    "Vmin_1_0": 11.903454909527573,
                    "Vmax_1_0": 364.3533835355211,
                    "Vmin_1_1": 8.577254848856047,
                    "Vmax_1_1": 505.6471037032689,
                    "H_2": 1.0,
                    "P_2": 0.21069354008543448,
                    "V_2": 77.78475302706872,
                    "Vmin_2_0": 14.059490714554881,
                    "Vmax_2_0": 430.34757988910803,
                    "Vmin_2_1": 10.130826371034534,
                    "Vmax_2_1": 597.2333926066703,
                    "I_0_0": 37.72653459,
                    "R_0_0": 9.43163365,
                    "I_0_1": 49.14439534,
                    "R_0_1": 12.28609883,
                    "I_1_0": 29.12758447,
                    "R_1_0": 14.56379223,
                    "I_1_1": 37.99182885,
                    "R_1_1": 18.99591443,
                    "I_2_0": 24.88372093,
                    "R_2_0": 24.88372093,
                    "I_2_1": 33.40009526,
                    "R_2_1": 33.40009526,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [
                        (55.0, -15.0),
                        (55.0, -25.0),
                        (55.0, -35.0),
                        (55.0, -45.0),
                        (55.0, -55.0),
                    ],
                    "type": "LineString",
                },
                "id": "1",
                "properties": {
                    "Segment_ID": 2,
                    "Area_km2": 0.0011,
                    "ExtRatio": 0.0011,
                    "BurnRatio": 0.0011,
                    "Slope": 0.0011,
                    "ConfAngle": 0.0011,
                    "DevAreaKm2": 0.0011,
                    "InPerim": 0,
                    "Terrain_M1": 0.36363636363636365,
                    "Fire_M1": 0.39972727272727276,
                    "Soil_M1": 0.2,
                    "Bmh_km2": 0.0004,
                    "Relief_m": 53.0,
                    "H_0": 1.0,
                    "P_0": 0.1974407297165962,
                    "V_0": 49.886864004447645,
                    "Vmin_0_0": 9.016984356879242,
                    "Vmax_0_0": 276.0012773338765,
                    "Vmin_0_1": 6.497355043971106,
                    "Vmax_0_1": 383.0326622688594,
                    "H_1": 1.0,
                    "P_1": 0.30038628353884217,
                    "V_1": 59.97277709314705,
                    "Vmin_1_0": 10.839999740999959,
                    "Vmax_1_0": 331.8020367344136,
                    "Vmin_1_1": 7.810962535395557,
                    "Vmax_1_1": 460.47256992536074,
                    "H_2": 2.0,
                    "P_2": 0.4283586654690534,
                    "V_2": 70.83545987915497,
                    "Vmin_2_0": 12.803415215391018,
                    "Vmax_2_0": 391.90030877539823,
                    "Vmin_2_1": 9.22573791162354,
                    "Vmax_2_1": 543.8765358779164,
                    "I_0_0": 26.07252052,
                    "R_0_0": 6.51813013,
                    "I_0_1": 33.96331706,
                    "R_0_1": 8.49082927,
                    "I_1_0": 20.60272437,
                    "R_1_0": 10.30136219,
                    "I_1_1": 26.87264298,
                    "R_1_1": 13.43632149,
                    "I_2_0": 17.28002349,
                    "R_2_0": 17.28002349,
                    "I_2_1": 23.19405656,
                    "R_2_1": 23.19405656,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [
                        (55.0, -55.0),
                        (55.0, -65.0),
                        (55.0, -75.0),
                        (65.0, -75.0),
                        (65.0, -85.0),
                        (75.0, -85.0),
                        (75.0, -95.0),
                        (85.0, -95.0),
                    ],
                    "type": "LineString",
                },
                "id": "2",
                "properties": {
                    "Segment_ID": 3,
                    "Area_km2": 0.0041,
                    "ExtRatio": 0.0041,
                    "BurnRatio": 0.0041,
                    "Slope": 0.0041,
                    "ConfAngle": 0.0041,
                    "DevAreaKm2": 0.0041,
                    "InPerim": 1,
                    "Terrain_M1": 0.3902439024390244,
                    "Fire_M1": 0.3340487804878049,
                    "Soil_M1": 0.5103448275862067,
                    "Bmh_km2": 0.0019,
                    "Relief_m": 115.0,
                    "H_0": 1.0,
                    "P_0": 0.33944157137566416,
                    "V_0": 136.77950639439854,
                    "Vmin_0_0": 24.722713967147698,
                    "Vmax_0_0": 756.738657186097,
                    "Vmin_0_1": 17.8144093343749,
                    "Vmax_0_1": 1050.196670478145,
                    "H_1": 2.0,
                    "P_1": 0.5188086983904726,
                    "V_1": 164.43300278747938,
                    "Vmin_1_0": 29.72104668189192,
                    "Vmax_1_0": 909.7328467298136,
                    "Vmin_1_1": 21.416050525069945,
                    "Vmax_1_1": 1262.52094773758,
                    "H_2": 2.0,
                    "P_2": 0.6934555500473673,
                    "V_2": 194.21624170697987,
                    "Vmin_2_0": 35.10432752733432,
                    "Vmax_2_0": 1074.5099308173058,
                    "Vmin_2_1": 25.295073219343944,
                    "Vmax_2_1": 1491.1974444864777,
                    "I_0_0": 19.59371217,
                    "R_0_0": 4.89842804,
                    "I_0_1": 25.52371024,
                    "R_0_1": 6.38092756,
                    "I_1_0": 14.82805455,
                    "R_1_0": 7.41402728,
                    "I_1_1": 19.34059831,
                    "R_1_1": 9.67029915,
                    "I_2_0": 13.07924121,
                    "R_2_0": 13.07924121,
                    "I_2_1": 17.55556991,
                    "R_2_1": 17.55556991,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [
                        (105.0, -15.0),
                        (95.0, -15.0),
                        (85.0, -15.0),
                        (85.0, -25.0),
                        (85.0, -35.0),
                        (95.0, -35.0),
                        (105.0, -35.0),
                        (105.0, -45.0),
                        (105.0, -55.0),
                        (95.0, -55.0),
                        (85.0, -55.0),
                        (85.0, -65.0),
                        (85.0, -75.0),
                        (95.0, -75.0),
                        (105.0, -75.0),
                        (95.0, -85.0),
                        (85.0, -95.0),
                    ],
                    "type": "LineString",
                },
                "id": "3",
                "properties": {
                    "Segment_ID": 4,
                    "Area_km2": 0.0027,
                    "ExtRatio": 0.0027,
                    "BurnRatio": 0.0027,
                    "Slope": 0.0027,
                    "ConfAngle": 0.0027,
                    "DevAreaKm2": 0.0027,
                    "InPerim": 1,
                    "Terrain_M1": 0.2962962962962963,
                    "Fire_M1": 0.310962962962963,
                    "Soil_M1": 0.5333333333333331,
                    "Bmh_km2": 0.0009,
                    "Relief_m": 105.0,
                    "H_0": 1.0,
                    "P_0": 0.3063243458016907,
                    "V_0": 98.23690048902354,
                    "Vmin_0_0": 17.756189182363812,
                    "Vmax_0_0": 543.4999885716236,
                    "Vmin_0_1": 12.79455090301004,
                    "Vmax_0_1": 754.2655221622468,
                    "H_1": 2.0,
                    "P_1": 0.47148098782259124,
                    "V_1": 118.09801744251992,
                    "Vmin_1_0": 21.346059671393938,
                    "Vmax_1_0": 653.3824948753631,
                    "Vmin_1_1": 15.381298556765039,
                    "Vmax_1_1": 906.7597038300433,
                    "H_2": 2.0,
                    "P_2": 0.6431264858393877,
                    "V_2": 139.488744424231,
                    "Vmin_2_0": 25.212405139795546,
                    "Vmax_2_0": 771.7276361840275,
                    "Vmin_2_1": 18.167265376335784,
                    "Vmax_2_1": 1070.998271781331,
                    "I_0_0": 20.64963877,
                    "R_0_0": 5.16240969,
                    "I_0_1": 26.89921093,
                    "R_0_1": 6.72480273,
                    "I_1_0": 15.52757431,
                    "R_1_0": 7.76378715,
                    "I_1_1": 20.25299922,
                    "R_1_1": 10.12649961,
                    "I_2_0": 13.96281737,
                    "R_2_0": 13.96281737,
                    "I_2_1": 18.7415472,
                    "R_2_1": 18.7415472,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [(85.0, -95.0), (85.0, -105.0), (85.0, -115.0)],
                    "type": "LineString",
                },
                "id": "4",
                "properties": {
                    "Segment_ID": 5,
                    "Area_km2": 0.0075,
                    "ExtRatio": 0.0075,
                    "BurnRatio": 0.0075,
                    "Slope": 0.0075,
                    "ConfAngle": 0.0075,
                    "DevAreaKm2": 0.0075,
                    "InPerim": 1,
                    "Terrain_M1": 0.32,
                    "Fire_M1": 0.3038933333333333,
                    "Soil_M1": 0.48571428571428543,
                    "Bmh_km2": 0.0028,
                    "Relief_m": 128.0,
                    "H_0": 1.0,
                    "P_0": 0.28276936259898294,
                    "V_0": 169.8054202285712,
                    "Vmin_0_0": 30.69210399310377,
                    "Vmax_0_0": 939.4559833851852,
                    "Vmin_0_1": 22.115763851529675,
                    "Vmax_0_1": 1303.7705110514332,
                    "H_1": 2.0,
                    "P_1": 0.43635774359843155,
                    "V_1": 204.1359548210595,
                    "Vmin_1_0": 36.8973024869632,
                    "Vmax_1_0": 1129.391181521449,
                    "Vmin_1_1": 26.587034526648516,
                    "Vmax_1_1": 1567.3612643387437,
                    "H_2": 2.0,
                    "P_2": 0.6032083194607211,
                    "V_2": 241.11046608966302,
                    "Vmin_2_0": 43.58039625053449,
                    "Vmax_2_0": 1333.9542973352748,
                    "Vmin_2_1": 31.40266148744544,
                    "Vmax_2_1": 1851.2525405280126,
                    "I_0_0": 21.51721456,
                    "R_0_0": 5.37930364,
                    "I_0_1": 28.0293568,
                    "R_0_1": 7.0073392,
                    "I_1_0": 16.2402096,
                    "R_1_0": 8.1201048,
                    "I_1_1": 21.18250706,
                    "R_1_1": 10.59125353,
                    "I_2_0": 14.45712746,
                    "R_2_0": 14.45712746,
                    "I_2_1": 19.40503335,
                    "R_2_1": 19.40503335,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [
                        (15.0, -75.0),
                        (25.0, -75.0),
                        (25.0, -85.0),
                        (25.0, -95.0),
                        (25.0, -105.0),
                    ],
                    "type": "LineString",
                },
                "id": "5",
                "properties": {
                    "Segment_ID": 6,
                    "Area_km2": 0.0005,
                    "ExtRatio": 0.0005,
                    "BurnRatio": 0.0005,
                    "Slope": 0.0005,
                    "ConfAngle": 0.0005,
                    "DevAreaKm2": 0.0005,
                    "InPerim": 0,
                    "Terrain_M1": 0.2,
                    "Fire_M1": 0.24,
                    "Soil_M1": 0.4,
                    "Bmh_km2": 0.0001,
                    "Relief_m": 110.0,
                    "H_0": 1.0,
                    "P_0": 0.17670978718234837,
                    "V_0": 45.95804746439109,
                    "Vmin_0_0": 8.306855989628495,
                    "Vmax_0_0": 254.26492639048206,
                    "Vmin_0_1": 5.985658899649471,
                    "Vmax_0_1": 352.86710488345994,
                    "H_1": 1.0,
                    "P_1": 0.2658072840086264,
                    "V_1": 55.24964920570006,
                    "Vmin_1_0": 9.986300653543736,
                    "Vmax_1_0": 305.67112319712675,
                    "Vmin_1_1": 7.195813850160736,
                    "Vmax_1_1": 424.2082689902724,
                    "H_2": 1.0,
                    "P_2": 0.3791400196952891,
                    "V_2": 65.25684651169763,
                    "Vmin_2_0": 11.795088264573753,
                    "Vmax_2_0": 361.03638405499936,
                    "Vmin_2_1": 8.499169256231973,
                    "Vmax_2_1": 501.0437947836811,
                    "I_0_0": 27.77352716,
                    "R_0_0": 6.94338179,
                    "I_0_1": 36.17912998,
                    "R_0_1": 9.0447825,
                    "I_1_0": 20.8912037,
                    "R_1_0": 10.44560185,
                    "I_1_1": 27.24891371,
                    "R_1_1": 13.62445685,
                    "I_2_0": 18.88235294,
                    "R_2_0": 18.88235294,
                    "I_2_1": 25.34477817,
                    "R_2_1": 25.34477817,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [
                        (55.0, -105.0),
                        (45.0, -105.0),
                        (35.0, -105.0),
                        (25.0, -105.0),
                    ],
                    "type": "LineString",
                },
                "id": "6",
                "properties": {
                    "Segment_ID": 7,
                    "Area_km2": 0.0009,
                    "ExtRatio": 0.0009,
                    "BurnRatio": 0.0009,
                    "Slope": 0.0009,
                    "ConfAngle": 0.0009,
                    "DevAreaKm2": 0.0009,
                    "InPerim": 0,
                    "Terrain_M1": 0.0,
                    "Fire_M1": 0.23333333333333334,
                    "Soil_M1": 0.3111111111111111,
                    "Bmh_km2": 0.0001,
                    "Relief_m": 123.0,
                    "H_0": 1.0,
                    "P_0": 0.10587792310700649,
                    "V_0": 49.70210130173497,
                    "Vmin_0_0": 8.983588743959045,
                    "Vmax_0_0": 274.9790695248669,
                    "Vmin_0_1": 6.473291216701848,
                    "Vmax_0_1": 381.6140493469945,
                    "H_1": 1.0,
                    "P_1": 0.1468599328645283,
                    "V_1": 59.750659856354474,
                    "Vmin_1_0": 10.799852345698195,
                    "Vmax_1_0": 330.5731633166108,
                    "Vmin_1_1": 7.782033586309912,
                    "Vmax_1_1": 458.76714790210275,
                    "H_2": 1.0,
                    "P_2": 0.20015380877836433,
                    "V_2": 70.57311123735617,
                    "Vmin_2_0": 12.755996047111822,
                    "Vmax_2_0": 390.44885333340443,
                    "Vmin_2_1": 9.1915691518691,
                    "Vmax_2_1": 541.8622160621458,
                    "I_0_0": 38.81199881,
                    "R_0_0": 9.7029997,
                    "I_0_1": 50.55837315,
                    "R_0_1": 12.63959329,
                    "I_1_0": 29.28346102,
                    "R_1_0": 14.64173051,
                    "I_1_1": 38.19514249,
                    "R_1_1": 19.09757125,
                    "I_2_0": 27.88610039,
                    "R_2_0": 27.88610039,
                    "I_2_1": 37.43002953,
                    "R_2_1": 37.43002953,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [(25.0, -105.0), (15.0, -105.0), (5.0, -105.0)],
                    "type": "LineString",
                },
                "id": "7",
                "properties": {
                    "Segment_ID": 8,
                    "Area_km2": 0.0016,
                    "ExtRatio": 0.0016,
                    "BurnRatio": 0.0016,
                    "Slope": 0.0016,
                    "ConfAngle": 0.0016,
                    "DevAreaKm2": 0.0016,
                    "InPerim": 0,
                    "Terrain_M1": 0.0625,
                    "Fire_M1": 0.23125,
                    "Soil_M1": 0.325,
                    "Bmh_km2": 0.0002,
                    "Relief_m": 121.0,
                    "H_0": 1.0,
                    "P_0": 0.11943936006809144,
                    "V_0": 63.04258504227519,
                    "Vmin_0_0": 11.394863447274302,
                    "Vmax_0_0": 348.7858847280163,
                    "Vmin_0_1": 8.210779853247248,
                    "Vmax_0_1": 484.0426366127321,
                    "H_1": 1.0,
                    "P_1": 0.1694278680367696,
                    "V_1": 75.78826561996475,
                    "Vmin_1_0": 13.698628269544148,
                    "Vmax_1_0": 419.3019251754229,
                    "Vmin_1_1": 9.870800254267296,
                    "Vmax_1_1": 581.9043094504088,
                    "H_2": 1.0,
                    "P_2": 0.23476014271669624,
                    "V_2": 89.51555870583819,
                    "Vmin_2_0": 16.17981824786353,
                    "Vmax_2_0": 495.2487801571227,
                    "Vmin_2_1": 11.658667636823507,
                    "Vmax_2_1": 687.3028291079731,
                    "I_0_0": 35.5827845,
                    "R_0_0": 8.89569612,
                    "I_0_1": 46.35184354,
                    "R_0_1": 11.58796089,
                    "I_1_0": 26.84638624,
                    "R_1_0": 13.42319312,
                    "I_1_1": 35.01640559,
                    "R_1_1": 17.50820279,
                    "I_2_0": 25.00486855,
                    "R_2_0": 25.00486855,
                    "I_2_1": 33.56270527,
                    "R_2_1": 33.56270527,
                },
                "type": "Feature",
            },
        ]
        check_records(records, expected)

        with fiona.open(assessment / "basins.geojson") as file:
            records = list(file)
        records = [record.__geo_interface__ for record in records]
        expected = [
            {
                "geometry": {
                    "coordinates": [
                        [
                            (10.0, -10.0),
                            (10.0, -50.0),
                            (20.0, -50.0),
                            (20.0, -60.0),
                            (30.0, -60.0),
                            (30.0, -70.0),
                            (40.0, -70.0),
                            (40.0, -80.0),
                            (50.0, -80.0),
                            (50.0, -90.0),
                            (60.0, -90.0),
                            (60.0, -100.0),
                            (70.0, -100.0),
                            (70.0, -110.0),
                            (110.0, -110.0),
                            (110.0, -70.0),
                            (90.0, -70.0),
                            (90.0, -60.0),
                            (110.0, -60.0),
                            (110.0, -30.0),
                            (90.0, -30.0),
                            (90.0, -20.0),
                            (110.0, -20.0),
                            (110.0, -10.0),
                            (10.0, -10.0),
                        ]
                    ],
                    "type": "Polygon",
                },
                "id": "0",
                "properties": {
                    "Segment_ID": 5,
                    "Area_km2": 0.0075,
                    "ExtRatio": 0.0075,
                    "BurnRatio": 0.0075,
                    "Slope": 0.0075,
                    "ConfAngle": 0.0075,
                    "DevAreaKm2": 0.0075,
                    "InPerim": 1,
                    "Terrain_M1": 0.32,
                    "Fire_M1": 0.3038933333333333,
                    "Soil_M1": 0.48571428571428543,
                    "Bmh_km2": 0.0028,
                    "Relief_m": 128.0,
                    "H_0": 1.0,
                    "P_0": 0.28276936259898294,
                    "V_0": 169.8054202285712,
                    "Vmin_0_0": 30.69210399310377,
                    "Vmax_0_0": 939.4559833851852,
                    "Vmin_0_1": 22.115763851529675,
                    "Vmax_0_1": 1303.7705110514332,
                    "H_1": 2.0,
                    "P_1": 0.43635774359843155,
                    "V_1": 204.1359548210595,
                    "Vmin_1_0": 36.8973024869632,
                    "Vmax_1_0": 1129.391181521449,
                    "Vmin_1_1": 26.587034526648516,
                    "Vmax_1_1": 1567.3612643387437,
                    "H_2": 2.0,
                    "P_2": 0.6032083194607211,
                    "V_2": 241.11046608966302,
                    "Vmin_2_0": 43.58039625053449,
                    "Vmax_2_0": 1333.9542973352748,
                    "Vmin_2_1": 31.40266148744544,
                    "Vmax_2_1": 1851.2525405280126,
                    "I_0_0": 21.51721456,
                    "R_0_0": 5.37930364,
                    "I_0_1": 28.0293568,
                    "R_0_1": 7.0073392,
                    "I_1_0": 16.2402096,
                    "R_1_0": 8.1201048,
                    "I_1_1": 21.18250706,
                    "R_1_1": 10.59125353,
                    "I_2_0": 14.45712746,
                    "R_2_0": 14.45712746,
                    "I_2_1": 19.40503335,
                    "R_2_1": 19.40503335,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [
                        [
                            (20.0, -60.0),
                            (20.0, -70.0),
                            (10.0, -70.0),
                            (10.0, -80.0),
                            (20.0, -80.0),
                            (20.0, -100.0),
                            (10.0, -100.0),
                            (10.0, -110.0),
                            (60.0, -110.0),
                            (60.0, -90.0),
                            (50.0, -90.0),
                            (50.0, -80.0),
                            (40.0, -80.0),
                            (40.0, -70.0),
                            (30.0, -70.0),
                            (30.0, -60.0),
                            (20.0, -60.0),
                        ]
                    ],
                    "type": "Polygon",
                },
                "id": "1",
                "properties": {
                    "Segment_ID": 8,
                    "Area_km2": 0.0016,
                    "ExtRatio": 0.0016,
                    "BurnRatio": 0.0016,
                    "Slope": 0.0016,
                    "ConfAngle": 0.0016,
                    "DevAreaKm2": 0.0016,
                    "InPerim": 0,
                    "Terrain_M1": 0.0625,
                    "Fire_M1": 0.23125,
                    "Soil_M1": 0.325,
                    "Bmh_km2": 0.0002,
                    "Relief_m": 121.0,
                    "H_0": 1.0,
                    "P_0": 0.11943936006809144,
                    "V_0": 63.04258504227519,
                    "Vmin_0_0": 11.394863447274302,
                    "Vmax_0_0": 348.7858847280163,
                    "Vmin_0_1": 8.210779853247248,
                    "Vmax_0_1": 484.0426366127321,
                    "H_1": 1.0,
                    "P_1": 0.1694278680367696,
                    "V_1": 75.78826561996475,
                    "Vmin_1_0": 13.698628269544148,
                    "Vmax_1_0": 419.3019251754229,
                    "Vmin_1_1": 9.870800254267296,
                    "Vmax_1_1": 581.9043094504088,
                    "H_2": 1.0,
                    "P_2": 0.23476014271669624,
                    "V_2": 89.51555870583819,
                    "Vmin_2_0": 16.17981824786353,
                    "Vmax_2_0": 495.2487801571227,
                    "Vmin_2_1": 11.658667636823507,
                    "Vmax_2_1": 687.3028291079731,
                    "I_0_0": 35.5827845,
                    "R_0_0": 8.89569612,
                    "I_0_1": 46.35184354,
                    "R_0_1": 11.58796089,
                    "I_1_0": 26.84638624,
                    "R_1_0": 13.42319312,
                    "I_1_1": 35.01640559,
                    "R_1_1": 17.50820279,
                    "I_2_0": 25.00486855,
                    "R_2_0": 25.00486855,
                    "I_2_1": 33.56270527,
                    "R_2_1": 33.56270527,
                },
                "type": "Feature",
            },
        ]
        check_records(records, expected)

        with fiona.open(assessment / "outlets.geojson") as file:
            records = list(file)
        records = [record.__geo_interface__ for record in records]
        expected = [
            {
                "geometry": {"coordinates": (85.0, -115.0), "type": "Point"},
                "id": "0",
                "properties": {},
                "type": "Feature",
            },
            {
                "geometry": {"coordinates": (5.0, -105.0), "type": "Point"},
                "id": "1",
                "properties": {},
                "type": "Feature",
            },
        ]
        check_records(records, expected)

        logcheck.check(
            [
                ("INFO", "Saving results"),
                ("DEBUG", "    Finalizing properties"),
                ("DEBUG", "    Saving segments"),
                ("DEBUG", "    Saving basins"),
                ("DEBUG", "    Removing nested drainages"),
                ("DEBUG", "    Saving outlets"),
            ]
        )

    def test_no_basins(_, assessment, config, segments, all_props, logcheck):
        config["locate_basins"] = False
        for name in ["segments", "outlets", "basins"]:
            path = assessment / f"{name}.geojson"
            assert not path.exists()
        _save.results(assessment, config, segments, all_props, logcheck.log)

        for name in ["segments", "outlets"]:
            path = assessment / f"{name}.geojson"
            assert path.exists()

        basins = assessment / "basins.geojson"
        assert not basins.exists()

        logcheck.check(
            [
                ("INFO", "Saving results"),
                ("DEBUG", "    Finalizing properties"),
                ("DEBUG", "    Saving segments"),
                ("DEBUG", "    Removing nested drainages"),
                ("DEBUG", "    Saving outlets"),
            ]
        )

    def test_nested(_, assessment, config, segments, all_props, logcheck):

        # Monkey patch over isnested to ensure the presence of nested segments
        def isnested():
            return np.array([1, 1, 1, 1, 1, 0, 0, 0], bool)

        segments.isnested = isnested

        for name in ["segments", "outlets", "basins"]:
            path = assessment / f"{name}.geojson"
            assert not path.exists()
        _save.results(assessment, config, segments, all_props, logcheck.log)

        for name in ["segments", "outlets", "basins"]:
            path = assessment / f"{name}.geojson"
            assert path.exists()

        with fiona.open(assessment / "basins.geojson") as file:
            records = list(file)
        records = [record.__geo_interface__ for record in records]
        expected = [
            {
                "geometry": {
                    "coordinates": [
                        [
                            (10.0, -10.0),
                            (10.0, -50.0),
                            (20.0, -50.0),
                            (20.0, -60.0),
                            (30.0, -60.0),
                            (30.0, -70.0),
                            (40.0, -70.0),
                            (40.0, -80.0),
                            (50.0, -80.0),
                            (50.0, -90.0),
                            (60.0, -90.0),
                            (60.0, -100.0),
                            (70.0, -100.0),
                            (70.0, -110.0),
                            (110.0, -110.0),
                            (110.0, -70.0),
                            (90.0, -70.0),
                            (90.0, -60.0),
                            (110.0, -60.0),
                            (110.0, -30.0),
                            (90.0, -30.0),
                            (90.0, -20.0),
                            (110.0, -20.0),
                            (110.0, -10.0),
                            (10.0, -10.0),
                        ]
                    ],
                    "type": "Polygon",
                },
                "id": "0",
                "properties": {
                    "Segment_ID": 5,
                    "Area_km2": 0.0075,
                    "ExtRatio": 0.0075,
                    "BurnRatio": 0.0075,
                    "Slope": 0.0075,
                    "ConfAngle": 0.0075,
                    "DevAreaKm2": 0.0075,
                    "InPerim": 1,
                    "Terrain_M1": 0.32,
                    "Fire_M1": 0.3038933333333333,
                    "Soil_M1": 0.48571428571428543,
                    "Bmh_km2": 0.0028,
                    "Relief_m": 128.0,
                    "H_0": 1.0,
                    "P_0": 0.28276936259898294,
                    "V_0": 169.8054202285712,
                    "Vmin_0_0": 30.69210399310377,
                    "Vmax_0_0": 939.4559833851852,
                    "Vmin_0_1": 22.115763851529675,
                    "Vmax_0_1": 1303.7705110514332,
                    "H_1": 2.0,
                    "P_1": 0.43635774359843155,
                    "V_1": 204.1359548210595,
                    "Vmin_1_0": 36.8973024869632,
                    "Vmax_1_0": 1129.391181521449,
                    "Vmin_1_1": 26.587034526648516,
                    "Vmax_1_1": 1567.3612643387437,
                    "H_2": 2.0,
                    "P_2": 0.6032083194607211,
                    "V_2": 241.11046608966302,
                    "Vmin_2_0": 43.58039625053449,
                    "Vmax_2_0": 1333.9542973352748,
                    "Vmin_2_1": 31.40266148744544,
                    "Vmax_2_1": 1851.2525405280126,
                    "I_0_0": 21.51721456,
                    "R_0_0": 5.37930364,
                    "I_0_1": 28.0293568,
                    "R_0_1": 7.0073392,
                    "I_1_0": 16.2402096,
                    "R_1_0": 8.1201048,
                    "I_1_1": 21.18250706,
                    "R_1_1": 10.59125353,
                    "I_2_0": 14.45712746,
                    "R_2_0": 14.45712746,
                    "I_2_1": 19.40503335,
                    "R_2_1": 19.40503335,
                },
                "type": "Feature",
            },
            {
                "geometry": {
                    "coordinates": [
                        [
                            (20.0, -60.0),
                            (20.0, -70.0),
                            (10.0, -70.0),
                            (10.0, -80.0),
                            (20.0, -80.0),
                            (20.0, -100.0),
                            (10.0, -100.0),
                            (10.0, -110.0),
                            (60.0, -110.0),
                            (60.0, -90.0),
                            (50.0, -90.0),
                            (50.0, -80.0),
                            (40.0, -80.0),
                            (40.0, -70.0),
                            (30.0, -70.0),
                            (30.0, -60.0),
                            (20.0, -60.0),
                        ]
                    ],
                    "type": "Polygon",
                },
                "id": "1",
                "properties": {
                    "Segment_ID": 8,
                    "Area_km2": 0.0016,
                    "ExtRatio": 0.0016,
                    "BurnRatio": 0.0016,
                    "Slope": 0.0016,
                    "ConfAngle": 0.0016,
                    "DevAreaKm2": 0.0016,
                    "InPerim": 0,
                    "Terrain_M1": 0.0625,
                    "Fire_M1": 0.23125,
                    "Soil_M1": 0.325,
                    "Bmh_km2": 0.0002,
                    "Relief_m": 121.0,
                    "H_0": 1.0,
                    "P_0": 0.11943936006809144,
                    "V_0": 63.04258504227519,
                    "Vmin_0_0": 11.394863447274302,
                    "Vmax_0_0": 348.7858847280163,
                    "Vmin_0_1": 8.210779853247248,
                    "Vmax_0_1": 484.0426366127321,
                    "H_1": 1.0,
                    "P_1": 0.1694278680367696,
                    "V_1": 75.78826561996475,
                    "Vmin_1_0": 13.698628269544148,
                    "Vmax_1_0": 419.3019251754229,
                    "Vmin_1_1": 9.870800254267296,
                    "Vmax_1_1": 581.9043094504088,
                    "H_2": 1.0,
                    "P_2": 0.23476014271669624,
                    "V_2": 89.51555870583819,
                    "Vmin_2_0": 16.17981824786353,
                    "Vmax_2_0": 495.2487801571227,
                    "Vmin_2_1": 11.658667636823507,
                    "Vmax_2_1": 687.3028291079731,
                    "I_0_0": 35.5827845,
                    "R_0_0": 8.89569612,
                    "I_0_1": 46.35184354,
                    "R_0_1": 11.58796089,
                    "I_1_0": 26.84638624,
                    "R_1_0": 13.42319312,
                    "I_1_1": 35.01640559,
                    "R_1_1": 17.50820279,
                    "I_2_0": 25.00486855,
                    "R_2_0": 25.00486855,
                    "I_2_1": 33.56270527,
                    "R_2_1": 33.56270527,
                },
                "type": "Feature",
            },
        ]
        check_records(records, expected)

        with fiona.open(assessment / "outlets.geojson") as file:
            records = list(file)
        records = [record.__geo_interface__ for record in records]
        expected = [
            {
                "geometry": {"coordinates": (5.0, -105.0), "type": "Point"},
                "id": "0",
                "properties": {},
                "type": "Feature",
            },
        ]
        check_records(records, expected)

        logcheck.check(
            [
                ("INFO", "Saving results"),
                ("DEBUG", "    Finalizing properties"),
                ("DEBUG", "    Saving segments"),
                ("DEBUG", "    Saving basins"),
                ("DEBUG", "    Removing nested drainages"),
                ("DEBUG", "    Saving outlets"),
            ]
        )


class TestConfig:
    def test(_, assessment, paths, logcheck):
        config = {
            # Datasets
            "perimeter_p": Path("test"),
            "dem_p": Path("test"),
            "dnbr_p": None,
            "severity_p": None,
            "kf_p": None,
            "retainments_p": None,
            "excluded_p": Path("excluded"),
            "included_p": Path("included"),
            "iswater_p": None,
            "isdeveloped_p": None,
            # Units
            "dem_per_m": 1,
            # Delineate
            "min_area_km2": 0.025,
            "min_burned_area_km2": 0.1,
            "max_length_m": 500,
            # Filter
            "max_area_km2": 8,
            "max_exterior_ratio": 0.95,
            "min_burn_ratio": 0.25,
            "min_slope": 0.12,
            "max_developed_area_km2": 0.2,
            "max_confinement": 174,
            "confinement_neighborhood": 4,
            "flow_continuous": True,
            # Removed
            "remove_ids": [5, 8],
            # Modeling
            "I15_mm_hr": [16, 20, 24],
            "volume_CI": [0.9, 0.95],
            "durations": [15, 30, 60],
            "probabilities": [0.5, 0.75],
            # Basins
            "locate_basins": True,
            "parallelize_basins": False,
        }

        path = assessment / "configuration.txt"
        assert not path.exists()
        _save.config(assessment, config, paths, logcheck.log)
        assert path.exists()

        with open(path) as file:
            output = file.read()

        perimeter = paths["perimeter_p"]
        dem = paths["dem_p"]
        print(output)
        assert output == (
            f"# Assessment configuration for wildcat v{version()}\n"
            "\n"
            "# Preprocessed rasters\n"
            f'perimeter_p = r"{perimeter}"\n'
            f'dem_p = r"{dem}"\n'
            "dnbr_p = None\n"
            "severity_p = None\n"
            "kf_p = None\n"
            "retainments_p = None\n"
            "excluded_p = None\n"
            "included_p = None\n"
            "iswater_p = None\n"
            "isdeveloped_p = None\n"
            "\n"
            "# Unit conversions\n"
            "dem_per_m = 1\n"
            "\n"
            "# Network delineation\n"
            "min_area_km2 = 0.025\n"
            "min_burned_area_km2 = 0.1\n"
            "max_length_m = 500\n"
            "\n"
            "# Filtering\n"
            "max_area_km2 = 8\n"
            "max_exterior_ratio = 0.95\n"
            "min_burn_ratio = 0.25\n"
            "min_slope = 0.12\n"
            "max_developed_area_km2 = 0.2\n"
            "max_confinement = 174\n"
            "confinement_neighborhood = 4\n"
            "flow_continuous = True\n"
            "\n"
            "# Removed segments\n"
            "remove_ids = [5, 8]\n"
            "\n"
            "# Hazard Modeling\n"
            "I15_mm_hr = [16, 20, 24]\n"
            "volume_CI = [0.9, 0.95]\n"
            "durations = [15, 30, 60]\n"
            "probabilities = [0.5, 0.75]\n"
            "\n"
            "# Basins\n"
            "locate_basins = True\n"
            "parallelize_basins = False\n"
            "\n"
        )
